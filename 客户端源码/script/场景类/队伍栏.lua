--======================================================================--
-- @作者: GGE研究群: 342119466
-- @创建时间:   2018-03-03 02:34:19
-- @Last Modified time: 2025-06-04 16:04:47
--======================================================================--
local 场景类_队伍栏 = class()
local insert = table.insert
local remove = table.remove
local floor = math.floor
local tp,zts,zts1
local 队伍加成 ={
		    天覆阵={[1]="加成类型:全伤,加成数值:20%",[2]="加成类型:全伤,加成数值:20%",[3]="加成类型:全伤,加成数值:20%",[4]="加成类型:全伤,加成数值:20%",[5]="加成类型:全伤,加成数值:20%"},
            风扬阵={[1]="加成类型:全伤、速度,加成数值:20%、5%",[2]="加成类型:全伤,加成数值:10%",[3]="加成类型:全伤,加成数值:10%",[4]="加成类型:全伤,加成数值:10%",[5]="加成类型:全伤,加成数值:10%"},
            虎翼阵={[1]="加成类型:全伤,加成数值:25%",[2]="加成类型:全防,加成数值:20%",[3]="加成类型:全防,加成数值:20%",[4]="加成类型:物伤,加成数值:20%",[5]="加成类型:物伤,加成数值:20%"},
            云垂阵={[1]="加成类型:全防,加成数值:25%",[2]="加成类型:物防,加成数值:10%",[3]="加成类型:全伤,加成数值:20%",[4]="加成类型:速度,加成数值:10%",[5]="加成类型:速度,加成数值:10%"},
            鸟翔阵={[1]="加成类型:速度,加成数值:20%",[2]="加成类型:速度,加成数值:10%",[3]="加成类型:速度,加成数值:10%",[4]="加成类型:速度,加成数值:15%",[5]="加成类型:速度,加成数值:15%"},
            地载阵={[1]="加成类型:全防,加成数值:15%",[2]="加成类型:全伤,加成数值:15%",[3]="加成类型:全防,加成数值:15%",[4]="加成类型:全防,加成数值:15%",[5]="加成类型:速度,加成数值:10%"},
            龙飞阵={[1]="加成类型:法防,加成数值:20%",[2]="加成类型:物防,加成数值:20%",[3]="加成类型:速度,加成数值:20%",[4]="加成类型:法伤,加成数值:20%",[5]="加成类型:全伤,加成数值:10%"},
            蛇蟠阵={[1]="加成类型:法伤,加成数值:15%",[2]="加成类型:法伤,加成数值:15%",[3]="加成类型:法伤,加成数值:15%",[4]="加成类型:全伤,加成数值:10%",[5]="加成类型:全伤,加成数值:10%"},
            鹰啸阵={[1]="加成类型:物防,加成数值:10%",[2]="加成类型:速度,加成数值:15%",[3]="加成类型:速度,加成数值:15%",[4]="加成类型:全伤,加成数值:15%",[5]="加成类型:全伤,加成数值:10%"},
            雷绝阵={[1]="加成类型:固伤、宝宝全伤,加成数值:20%、10%",[2]="加成类型:固伤、宝宝全伤,加成数值:20%、10%",[3]="加成类型:固伤、宝宝全伤,加成数值:20%、10%",[4]="加成类型:固伤、宝宝全伤,加成数值:10%、10%",[5]="加成类型:固伤、宝宝全伤,加成数值:10%、10%"},
            八卦阵={[1]="加成类型:全伤、宝宝全伤,加成数值:15%、15%",[2]="加成类型:全伤、宝宝全伤,加成数值:15%、15%",[3]="加成类型:全伤、宝宝全伤,加成数值:15%、15%",[4]="加成类型:全伤、宝宝全伤,加成数值:15%、15%",[5]="加成类型:全伤、宝宝全伤,加成数值:15%、15%"},
            普通={[1]="加成类型:无,加成数值:无",[2]="加成类型:无,加成数值:无",[3]="加成类型:无,加成数值:无",[4]="加成类型:无,加成数值:无",[5]="加成类型:无,加成数值:无"},
             }
local 当前坐标 = 0
local 按钮宽度 = 45
function 场景类_队伍栏:初始化(根)
	self.ID = 11
	self.x = 100
	self.y = 169
	self.xx = 0
	self.yy = 0
	self.注释 = "队伍栏"
	self.可视 = false
	self.鼠标 = false
	self.焦点 = false
	self.可移动 = true
	self.队伍坐标 = {14,133,252,371,490}
	self.选中人物 = 0
	self.窗口时间 = 0
	tp = 根
	zts = tp.字体表.普通字体
	zts1 = tp.字体表.描边字体
  	self.控件类 = require("ggeui/加载类")()
	local 总控件 = self.控件类:创建控件('给予总控件')
	总控件:置可视(true,true)
	self.输入框 = 总控件:创建输入("最低等级输入",0,0,36,14)
	self.输入框:置可视(false,false)
	self.输入框:置限制字数(3)
	self.输入框:屏蔽快捷键(true)
	self.输入框:置光标颜色(-16777216)
	self.输入框:置文字颜色(-16777216)
   	self.输入框1 = 总控件:创建输入("最高等级输入",0,0,36,14)
   	self.输入框1:置数字模式()
	self.输入框1:置可视(false,false)
	self.输入框1:置限制字数(3)
	self.输入框1:屏蔽快捷键(true)
	self.输入框1:置光标颜色(-16777216)
	self.输入框1:置文字颜色(-16777216)
	self.计次=0
	-- 八卦阵属性内容映射
	self.属性内容 = {
		[1] = "防御",
		[2] = "法防", 
		[3] = "固伤",
		[4] = "召唤兽伤害",
		[5] = "速度",
		[6] = "法伤",
		[7] = "伤害",
		[8] = "等级"
	}
end

function 场景类_队伍栏:打开()
	if self.可视 then
		for i=1,5 do
			self.队伍格子[i].禁止 = false
		end
		self.选中人物 = 0
		self.计次=0
		self.可视 = false
		self.输入框:置可视(false,false)
		self.输入框1:置可视(false,false)
		self.资源组 = nil
		self.队伍格子 = nil
		return
	else
		insert(tp.窗口_,self)
		local 按钮 = tp._按钮
		local 自适应 = tp._自适应
		self.资源组 = {
			[1] = 自适应.创建(0,1,617,291+20,3,9),
			[2] = 按钮.创建(自适应.创建(18,4,16,16,4,3),0,0,4,true,true),
			[3] = 按钮.创建(自适应.创建(12,4,55,20,1,3),0,0,4,true,true,"阵型"),
			[4] = 按钮.创建(自适应.创建(12,4,45,20,1,3),0,0,4,true,true,"踢出"),
			[5] = 按钮.创建(自适应.创建(12,4,72,20,1,3),0,0,4,true,true,"申请列表"),
			[6] = 自适应.创建(1,1,613,18,1,3,nil,18),
			[7] = tp.资源:载入('登陆资源.wdf',"网易WDF动画",0x2231EBB4),
			[8] = 自适应.创建(3,1,93,18,1,3),
			[9] = 自适应.创建(3,1,36,18,1,3),
			[10] = 按钮.创建(自适应.创建(12,4,45,20,1,3),0,0,4,true,true,"离队"),
			[11] = 自适应.创建(2,1,116,141,3,9),
			[12] = 自适应.创建(3,1,117,18,1,3),
			[13] = 按钮.创建(自适应.创建(12,4,72,20,1,3),0,0,4,true,true,"转让队长"),
			[14] = 按钮.创建(自适应.创建(12,4,45,20,1,3),0,0,4,true,true,"等级"),
			[15] = 按钮.创建(自适应.创建(12,4,55,20,1,3),0,0,4,true,true,"查看"),
			[16] = 按钮.创建(自适应.创建(12,4,55,20,1,3),0,0,4,true,true,"多角"),

		}
		for n=2,4 do
			self.资源组[n]:绑定窗口_(11)
		end
		self.资源组[10]:绑定窗口_(11)
		for n=13,15 do
			self.资源组[n]:绑定窗口_(11)
		end




	    self.队伍阵法显示={}
	    for i=1,5 do
		    self.队伍阵法显示[i] = tp.资源:载入(wdf配置.."/pic/鬼谷子.png", "图片")
	    end
	    self.队伍添加={
	          [1]=按钮.创建(tp.资源:载入('新界面.wdf',"网易WDF动画",0x00000198),0,0,4,true,true),
	          [2]=按钮.创建(tp.资源:载入('新界面.wdf',"网易WDF动画",0x00000198),0,0,4,true,true),
	          [3]=按钮.创建(tp.资源:载入('新界面.wdf',"网易WDF动画",0x00000198),0,0,4,true,true),
	          [4]=按钮.创建(tp.资源:载入('新界面.wdf',"网易WDF动画",0x00000198),0,0,4,true,true),

	}
		for n=1,4 do
		   self.队伍添加[n]:绑定窗口_(11)
		end




		self.队伍格子 = {}
		local 格子 = require("script/系统类/队伍_格子")
		for i=1,5 do
			self.队伍格子[i] = 格子.创建(0,0,i,tp)
		end
		for i=1,5 do
			self.队伍格子[i]:置人物(tp.队伍数据[i])
		end

       self.计次=0
		tp.运行时间 = tp.运行时间 + 1
		self.窗口时间 = tp.运行时间
	    self.可视 = true
	    self.输入框:置可视(true,true)
	    self.输入框:置文本(0)
	    self.输入框1:置可视(true,true)
	    self.输入框1:置文本(0)
	    self.输入框:置文本(tp.队伍数据.限制等级[1])
	    self.输入框1:置文本(tp.队伍数据.限制等级[2])
	end
end

function 场景类_队伍栏:重置()
	if not self.可视 then
		return false
	end
	for i=1,5 do
		self.队伍格子[i]:置人物(tp.队伍数据[i])
	end
end

function 场景类_队伍栏:显示(dt,x,y)
	self.焦点 = false
	self.资源组[2]:更新(x,y)
	if tp.场景.人物.队长开关==nil then
	    tp.场景.人物.队长开关=false
	end
	self.资源组[3]:更新(x,y,tp.场景.人物.队长开关)
	self.资源组[4]:更新(x,y,self.选中人物 ~= 0 and #tp.队伍数据 > 1 and tp.场景.人物.队长开关)
	self.资源组[13]:更新(x,y,self.选中人物 ~= 0 and #tp.队伍数据 > 1 and tp.场景.人物.队长开关)
	self.资源组[5]:更新(x,y,tp.场景.人物.队长开关 )
	self.资源组[10]:更新(x,y)
	self.资源组[14]:更新(x,y,tp.场景.人物.队长开关)
	self.资源组[15]:更新(x,y,self.选中人物 ~= 0 and tp.场景.人物.队长开关)
	self.资源组[16]:更新(x,y,tp.场景.人物.队长开关)

	if self.资源组[2]:事件判断() then
		self:打开()
		return false
	elseif self.资源组[3]:事件判断() then
		请求服务(4008)

	elseif self.资源组[4]:事件判断() then
		tp.窗口.文本栏:载入("#R/真的要踢出等级为"..tp.队伍数据[self.选中人物].等级.."的队员"..tp.队伍数据[self.选中人物].名称.."吗？","踢出人物",true)
	elseif self.资源组[5]:事件判断() then  --申请列表
		请求服务(4003)
	elseif self.资源组[10]:事件判断() then
		 请求服务(4006)
	elseif self.资源组[13]:事件判断() then
		请求服务(4010,{序列=self.选中人物})
		self:打开()
		return false
	elseif self.资源组[14]:事件判断() then
      if self.输入框:取文本()=="" or self.输入框1:取文本()=="" or (self.输入框:取文本() == self.输入框1:取文本()) then
        tp.常规提示:打开("输入等级错误!")
        return
      elseif self.输入框:取文本()+0>self.输入框1:取文本()+0 then
        tp.常规提示:打开("设置的最低等级不能比最高等级低噢!")
        return
      end
      if self.输入框:取文本()+0>175 then
        self.输入框1:置文本(175)
      end
		请求服务(4012,{序列={self.输入框:取文本(),self.输入框1:取文本()}})
	elseif self.资源组[15]:事件判断() and self.选中人物~=nil and self.选中人物~=0 then
		请求服务(4011,{序列=self.选中人物})
	elseif self.资源组[16]:事件判断() then
		-- 只有队长才能打开多开系统
		if tp.场景.人物.队长开关 then
			if tp.窗口.多开系统.可视 then
				tp.窗口.多开系统:打开()
			else
				-- 先获取角色信息，再打开多开系统
				请求服务(63,{参数=tp.队伍[1].数字id,文本="获取角色信息"})
			end
		else
			tp.常规提示:打开("#Y/只有队长才能打开多开系统！")
		end

	end
	self.资源组[1]:显示(self.x,self.y)
	self.资源组[6]:显示(self.x + 2,self.y + 2)
	self.资源组[2]:显示(self.x + 596,self.y + 2)
	tp.窗口标题背景_[4]:显示(self.x+self.资源组[1].宽度/2-60,self.y+2)
	self.资源组[7]:更新(dt)
	self.资源组[7]:显示(self.x + 63,self.y + 58)
	self.资源组[8]:显示(self.x+154,self.y+33+10)
	self.资源组[14]:显示(self.x + 395,self.y + 28)--等级
	self.资源组[15]:显示(self.x + 395,self.y + 55)
	当前坐标=self.x + 395+按钮宽度+5
	self.资源组[4]:显示(当前坐标,self.y + 28)--踢出
	self.资源组[5]:显示(self.x + 455,self.y + 55)
	self.资源组[13]:显示(self.x + 530,self.y + 55)
	当前坐标=当前坐标+按钮宽度+5
	self.资源组[10]:显示(当前坐标,self.y + 28)--离队
	当前坐标=当前坐标+按钮宽度+5
	self.资源组[16]:显示(当前坐标,self.y + 28)--多角色
	zts1:置字间距(3)
	zts1:显示(self.x+self.资源组[1].宽度/2-30,self.y+2,"队伍列表")
	zts1:置字间距(0)
	zts1:显示(self.x+15,self.y+35+10,"令牌")
	zts1:显示(self.x+252,self.y+35+10,"等级：")
	zts1:显示(self.x+334,self.y+35+10,"至")
	self.资源组[3]:显示(self.x + 89,self.y + 32+10)
	self.资源组[9]:显示(self.x+292,self.y+33+10)
	self.资源组[9]:显示(self.x+354,self.y+33+10)
	zts:置颜色(-16777216)
	zts:显示(self.x + 164,self.y + 37+10,tp.队伍数据.阵型)
	self.输入框:置坐标(self.x + 300,self.y + 37+10)
	self.输入框1:置坐标(self.x + 360,self.y + 37+10)
	if self.计次时间 and os.time()-self.计次时间>=1 then
		self.计次= 0
		self.计次时间 = nil
	end
	for i=0,4 do
		local jx = 11+i*120
		self.资源组[11]:显示(self.x+jx,self.y+63+20)
		for n=0,2 do
			self.资源组[12]:显示(self.x+jx,self.y+211+n*24+20)
		end
		i = i + 1
		self.队伍格子[i]:置坐标(self.x + jx,self.y + 63+20)
		self.队伍格子[i]:显示(dt,x,y+20,self.鼠标,tp.队伍数据)
		if self.队伍格子[i].事件 then
			if self.选中人物 ~= 0 and self.选中人物 ~= i then
				self.队伍格子[self.选中人物].禁止 = false
				self.选中人物 = i
				self.队伍格子[self.选中人物].禁止 = true
				self.计次=1
				self.计次时间 = os.time()
			else
				self.选中人物 = i
				self.队伍格子[self.选中人物].禁止 = true
				self.计次=self.计次+1
				self.计次时间 = os.time()
				if 多角色操作 and self.计次>=2 then
				   self.计次 = 0
			      请求服务(63,{参数=tp.队伍数据[self.选中人物].id,文本="切换角色"})
			    end
			end

		elseif self.队伍格子[i].互换 then
			if self.选中人物 ~= 0 and self.选中人物 ~= i then
				请求服务(4013,{序列=self.选中人物,目标=i})
			end
		end
		zts1:显示(self.x+jx+88,self.y+182+20,i)
		self.队伍阵法显示[i]:显示(self.x+10+jx+70,self.y+85)
		if self.队伍阵法显示[i]:是否选中(x,y) then
			local 显示加成 = 队伍加成[tp.队伍数据.阵型][i]
			-- 如果是八卦阵，需要动态计算加成
			if tp.队伍数据.阵型 == "八卦阵" then
				local 最终加成 = ""
				-- 添加八卦阵属性数据
				if tp.队伍[1] and tp.队伍[1].高级阵法 and tp.队伍[1].高级阵法.八卦阵 then
					-- 直接使用服务端返回的类型和数值
					for 序号, 属性配置 in pairs(tp.队伍[1].高级阵法.八卦阵) do
						if 属性配置 and 属性配置.类型 and 属性配置.数值 then
							local 属性名 = 属性配置.类型
							local 数值 = 属性配置.数值
							-- 等级不加%，其他属性加%
							if 属性名 == "等级" then
								最终加成 = 最终加成 .. 属性名 .. ": " .. tostring(数值) .. "\n"
							else
								最终加成 = 最终加成 .. 属性名 .. ": " .. tostring(数值) .. "%\n"
							end
						end
					end
					-- 如果没有高级阵法数据，显示默认加成
					if 最终加成 == "" then
						最终加成 = "防御: 15%\n法防: 15%\n固伤: 15%\n召唤兽伤害: 15%\n速度: 15%\n法伤: 15%\n伤害: 15%\n等级: 1"
					end
				else
					-- 没有高级阵法数据时显示默认加成
					最终加成 = "防御: 15%\n法防: 15%\n固伤: 15%\n召唤兽伤害: 15%\n速度: 15%\n法伤: 15%\n伤害: 15%\n等级: 1"
				end
				显示加成 = 最终加成
			end
			tp.提示:自定义(x,y+20,"#Y/"..显示加成)
		end
		if tp.队伍数据[i]==nil then
			 self.队伍添加[i-1]:更新(x,y,tp.场景.人物.队长开关)
			 self.队伍添加[i-1]:显示(self.x+10+jx,self.y+110)
			 if self.队伍添加[i-1]:事件判断() then
		    	if tp.窗口.多开系统.可视 then
				   tp.窗口.多开系统:打开()
				else
				   请求服务(63,{参数=tp.队伍[1].数字id,文本="获取角色信息"})
			    end
			 end
		end


	end




	self.控件类:更新(dt,x,y)
	if self.输入框._已碰撞 then
		self.焦点 = true
	end
	if self.输入框1._已碰撞 then
		self.焦点 = true
	end
	self.控件类:显示(x,y)
end

function 场景类_队伍栏:刷新人物()
   for i=1,5 do
	 self.队伍格子[i]:置人物(nil)
	 self.队伍格子[i]:置人物(tp.队伍数据[i])
   end
end

function 场景类_队伍栏:刷新(a,b,c)
	if a ~= nil then
		self.队伍格子[a]:置人物(tp.队伍数据[a])
	end
	if b ~= nil then
		self.队伍格子[b]:置人物(tp.队伍数据[b])
	end
	if c ~= nil then
		for i=1,5 do
			self.队伍格子[i]:置人物(tp.队伍数据[i])
		end
	end
	self.选中人物=0
end

function 场景类_队伍栏:踢出队伍()
	请求服务(4007,{序列=self.选中人物})
	self.选中人物=0
end

function 场景类_队伍栏:检查点(x,y)
	if self.可视 and self.资源组[1] ~= nil and  self.资源组[1]:是否选中(x,y)  then
		return true
	else
		return false
	end
end

function 场景类_队伍栏:初始移动(x,y)
	tp.运行时间 = tp.运行时间 + 1
	if not tp.消息栏焦点 then
  		self.窗口时间 = tp.运行时间
 	end
	if not self.焦点 then
		tp.移动窗口 = true
	end
	if self.可视 and self.鼠标 and  not self.焦点 then
		self.xx = x - self.x
		self.yy = y - self.y
	end
end

function 场景类_队伍栏:开始移动(x,y)
	if self.可视 and self.鼠标 then
		self.x = x - self.xx
		self.y = y - self.yy
	end
end

return 场景类_队伍栏